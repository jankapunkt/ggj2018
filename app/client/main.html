<head>
	<title>app</title>
</head>

<body>
<nav class="navbar navbar-default">
	<div class="container-fluid">
		<div class="navbar-header">
			<a class="navbar-brand" href="#">
				<img alt="Brand" src="./brand.png">
			</a>
		</div>
	</div>
</nav>
<script type="text/javascript">

	//////////////////////////////////////////////////////////////////
	//
	//	GLOBAL VARS
	//
	//////////////////////////////////////////////////////////////////

	const WIDTH = 1000;
	const HEIGHT = 400;
	const rescuers = [];

	//////////////////////////////////////////////////////////////////
	//
	//	SINGLETONS
	//
	//////////////////////////////////////////////////////////////////


	const Vec = {
		sub(v1, v2) {
			return createVector(v1.x - v2.x, v1.y - v2.y);
		}
	};

	const player = {
		pos: null,
		col: 255,
		size: 30,
		draw() {
			fill(this.col);
			ellipse(this.pos.x, this.pos.y, this.size);
			textSize(24);
			textAlign(CENTER);
			fill(0, 0, 255);
			stroke(0, 0, 0, 0);
			text('P', this.pos.x, this.pos.y + 9);
		}
	};

	//////////////////////////////////////////////////////////////////
	//
	//	DYNAMIC CLASSES
	//
	//////////////////////////////////////////////////////////////////

	class Movable {

		constructor({posX, posY, dirX, dirY,  speed = 4}) {
			this.pos = createVector(posX, posY);
			this.acc = createVector(0, 0);
			this.vel = createVector(0, 0);
			this.dir = createVector(dirX, dirY);
			this.speed = speed;
		}

		updateDir(x, y) {
			this.dir.set(x, y);
		}

		move() {
			const dir = Vec.sub(this.dir, this.pos);
			dir.normalize();
			dir.mult(0.5);
			this.acc = dir;

			this.vel.add(this.acc);
			this.vel.limit(this.speed);
			this.pos.add(this.vel);
		}

		hit(x2, y2) {
			const x = this.pos.x;
			const y = this.pos.y;
			const rad = 10;
			return !( x > ( x2 + rad ) || x < (x2 - rad) || y > ( y2 + rad ) || y < (y2 - rad) );
		}
	}

	class Signal extends Movable {
		constructor({posX, posY, dirX, dirY, speed = 4, col = 255, life = 1000, size = 5, strength = 100}) {
			super({posX, posY, dirX, dirY, speed});
			this.col = col;
			this.life = life;
			this.size = size;
			this.strength = strength;
			this.transmitters = [];
			this.isTransmitting = false;
			this.drawTarget = true;
		}

		isDead() { return this.life <= 0; }

		update() {

			if (!this.isTransmitting) {
				if (this.life % 100)
					this.drawTarget = !this.drawTarget;
				this.move();
				this.isTransmitting = this.hit(this.dir.x, this.dir.y);
				if (this.isTransmitting) {
					this.drawTarget = false;
					this.initTransmission();
				}
			} else {
				this.transmit();
			}

			// always
			this.life--;
		}

		initTransmission() {
			for (let i = 1; i < 5; i++) {
				this.transmitters.push(createTransmitter({
					pos: this.pos,
					index: i,
					strength: this.strength,
				}))
			}
		}

		transmit() {
			// init transmitters
			for (let transm of this.transmitters) {
				transm.update();
			}
		}

		draw() {
			// draw actual transmitter
			fill(this.life);
			ellipse(this.pos.x, this.pos.y, this.size);

			// draw target
			if (this.drawTarget) {
				fill(255, 255, 255, 0);
				stroke(255);
				ellipse(this.dir.x, this.dir.y, this.size * 3);
			}

			// draw transmitters wave
			if (this.isTransmitting) {
				for (let transm of this.transmitters) {
					transm.draw();
				}
			}

			// draw lifespan
			stroke(0);
			fill(255 - this.life, this.life, 0);
			textAlign(CENTER);
			textSize(20);
			text(this.life.toString(), this.pos.x, this.pos.y - 20);
		}

	}

	//////////////////////////////////////////////////////////////////
	//
	//	FACTORY FUNCTIONS
	//
	//////////////////////////////////////////////////////////////////


	function createTransmitter({pos, strength, index}) {
		return {
			pos,
			size: strength / index,
			strength: strength,
			index,
			update() {
				if (this.size > this.strength)
					this.size = 0;
				this.size++;
			},
			draw() {
				fill(0, 0, 0, 0);
				stroke(255);
				ellipse(this.pos.x, this.pos.y, this.size)
			}
		};
	}

	const signals = {
		list: [],
		update() {
			// draw signals
			let i;
			for (i = this.list.length - 1; i >= 0; i--) {
				const signal = this.list[i];
				if (signal.isDead()) {
					this.list.splice(i, 1);
				}
				signal.update();
				signal.draw();
			}

		},
		create({posX, posY, dirX, dirY}) {
			this.list.push(new Signal({posX, posY, dirX, dirY}))
		}
	};


	function mouseClicked() {
		signals.create({posX: player.pos.x, posY: player.pos.y, dirX: mouseX, dirY: mouseY});
	}

	function debugui() {
		textSize(12);
		fill(255);
		text('x: ' + mouseX.toString() + ' y: ' + mouseY.toString(), 20, 20);
	}

	function setup() {
		createCanvas(WIDTH, HEIGHT);
		player.pos = createVector(30, HEIGHT / 2);
		player.dir = createVector(0, 0);
	}

	function draw() {
		background(0);


		// always draw player
		player.draw();

		signals.update();

		// draw target spot
		stroke(255);
		fill(255, 255, 255, 0);
		ellipse(mouseX, mouseY, 30);

		debugui();
	}
</script>
</body>